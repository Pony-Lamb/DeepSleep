<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Export Test</title>
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass-nav {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .positive-change {
      color: #10b981;
    }

    .negative-change {
      color: #ef4444;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">PDF Export Test</h1>

    <!-- Test Controls -->
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Controls</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Portfolio Name</label>
          <input type="text" id="portfolioName" value="Test Portfolio"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
          <input type="number" id="userId" value="1"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="flex flex-wrap gap-4">
        <button onclick="testFullReport()"
          class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          <iconify-icon icon="mdi:file-pdf-box" class="mr-2"></iconify-icon>
          Test Full Report
        </button>

        <button onclick="testSimpleReport()"
          class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          <iconify-icon icon="mdi:file-document-outline" class="mr-2"></iconify-icon>
          Test Simple Report
        </button>

        <button onclick="testAPIEndpoints()"
          class="flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
          <iconify-icon icon="mdi:api" class="mr-2"></iconify-icon>
          Test API Endpoints
        </button>
      </div>
    </div>

    <!-- Test Results -->
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Results</h2>
      <div id="testResults" class="space-y-4">
        <div class="text-gray-500 text-center py-8">
          Click a test button above to see results
        </div>
      </div>
    </div>
  </div>

  <!-- API Service -->
  <script>
    class ApiService {
      constructor() {
        this.baseUrl = 'http://localhost:5000/api/v1';
        this.currentUserId = 1;
      }

      async makeRequest(endpoint, options = {}) {
        try {
          const url = `${this.baseUrl}${endpoint}`;
          console.log('API请求URL:', url);

          const response = await fetch(url, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            },
            ...options
          });

          console.log('API响应状态:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('API错误响应:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log('API响应数据:', data);
          return data;
        } catch (error) {
          console.error('API请求错误:', error);
          throw error;
        }
      }

      async exportPortfolioPDF(portfolioName, userId = this.currentUserId) {
        try {
          const url = `${this.baseUrl}/portfolio/export/${userId}/${encodeURIComponent(portfolioName)}`;
          console.log('导出PDF URL:', url);

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('PDF导出错误:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // 获取文件名
          const contentDisposition = response.headers.get('content-disposition');
          let filename = `portfolio_report_${portfolioName}.pdf`;
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }

          // 创建blob并下载
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(downloadUrl);

          return {
            code: 200,
            message: 'PDF导出成功',
            filename: filename
          };
        } catch (error) {
          console.error('PDF导出失败:', error);
          throw error;
        }
      }

      async exportSimplePortfolioPDF(portfolioName, userId = this.currentUserId) {
        try {
          const url = `${this.baseUrl}/portfolio/export/simple/${userId}/${encodeURIComponent(portfolioName)}`;
          console.log('导出简化PDF URL:', url);

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('简化PDF导出错误:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // 获取文件名
          const contentDisposition = response.headers.get('content-disposition');
          let filename = `portfolio_simple_${portfolioName}.pdf`;
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }

          // 创建blob并下载
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(downloadUrl);

          return {
            code: 200,
            message: '简化PDF导出成功',
            filename: filename
          };
        } catch (error) {
          console.error('简化PDF导出失败:', error);
          throw error;
        }
      }
    }

    const apiService = new ApiService();

    function addTestResult(message, type = 'info') {
      const resultsDiv = document.getElementById('testResults');
      const resultDiv = document.createElement('div');

      const bgColor = type === 'success' ? 'bg-green-50' :
        type === 'error' ? 'bg-red-50' :
          type === 'warning' ? 'bg-yellow-50' : 'bg-blue-50';

      const textColor = type === 'success' ? 'text-green-800' :
        type === 'error' ? 'text-red-800' :
          type === 'warning' ? 'text-yellow-800' : 'text-blue-800';

      const icon = type === 'success' ? 'mdi:check-circle' :
        type === 'error' ? 'mdi:alert-circle' :
          type === 'warning' ? 'mdi:alert' : 'mdi:information';

      resultDiv.className = `p-4 rounded-lg ${bgColor} ${textColor}`;
      resultDiv.innerHTML = `
                <div class="flex items-center">
                    <iconify-icon icon="${icon}" class="mr-2 text-lg"></iconify-icon>
                    <span>${message}</span>
                </div>
            `;

      resultsDiv.appendChild(resultDiv);
    }

    async function testFullReport() {
      const portfolioName = document.getElementById('portfolioName').value;
      const userId = document.getElementById('userId').value;

      addTestResult(`开始测试完整报告导出: ${portfolioName}`, 'info');

      try {
        const result = await apiService.exportPortfolioPDF(portfolioName, userId);
        addTestResult(`✅ 完整报告导出成功: ${result.filename}`, 'success');
      } catch (error) {
        addTestResult(`❌ 完整报告导出失败: ${error.message}`, 'error');
      }
    }

    async function testSimpleReport() {
      const portfolioName = document.getElementById('portfolioName').value;
      const userId = document.getElementById('userId').value;

      addTestResult(`开始测试简化报告导出: ${portfolioName}`, 'info');

      try {
        const result = await apiService.exportSimplePortfolioPDF(portfolioName, userId);
        addTestResult(`✅ 简化报告导出成功: ${result.filename}`, 'success');
      } catch (error) {
        addTestResult(`❌ 简化报告导出失败: ${error.message}`, 'error');
      }
    }

    async function testAPIEndpoints() {
      addTestResult('开始测试API端点', 'info');

      try {
        // 测试获取投资组合名称
        const portfolioResponse = await apiService.makeRequest(`/portfolio/name/1`);
        addTestResult(`✅ 获取投资组合名称端点正常: ${portfolioResponse.code}`, 'success');

        // 测试获取投资组合详情
        const detailsResponse = await apiService.makeRequest(`/portfolio/details?name=Test%20Portfolio`);
        addTestResult(`✅ 获取投资组合详情端点正常: ${detailsResponse.code}`, 'success');

      } catch (error) {
        addTestResult(`❌ API端点测试失败: ${error.message}`, 'error');
      }
    }
  </script>
</body>

</html>